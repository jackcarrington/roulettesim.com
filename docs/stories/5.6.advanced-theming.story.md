# Story 5.6: Advanced Theming & Brand Consistency

## Story Information

**Epic:** 5 - Brownfield Design System Enhancement
**Story Number:** 5.6
**Status:** Draft

## Story Statement

As a **marketing stakeholder**,
I want **sophisticated theming system supporting casino brand evolution**,
so that **visual authority can scale while maintaining current design system integrity**.

## Acceptance Criteria

**AC1: Extend current CSS variable architecture with theme switching capabilities**
- Build upon existing OKLCH color system to support multiple casino theme variants
- Implement theme switching that preserves current CSS variable naming conventions
- Create theme-aware component system maintaining existing component APIs
- Enable dynamic theme switching without requiring page reloads

**AC2: Create casino-specific theme variants using existing patterns**
- Develop "Classic Casino" theme with traditional red/green casino aesthetics
- Create "Modern Casino" theme with contemporary casino design language
- Implement "Premium Casino" theme for high-value customer segments
- Maintain educational theme as default while adding casino theme options

**AC3: Implement theme persistence using current localStorage/state management patterns**
- Integrate theme selection with existing `sessionState.ts` and nanostores patterns
- Implement theme persistence using current localStorage approach for GDPR compliance
- Create theme preference API compatible with existing analytics service
- Enable theme switching across all site sections while maintaining user preferences

**AC4: Maintain existing light-dark mode functionality within all new themes**
- Preserve current `light-dark()` CSS function automation across all casino themes
- Ensure WCAG 4.5:1+ contrast ratios maintained in both light and dark modes for all themes
- Implement theme-aware light-dark mode switching that respects user preferences
- Maintain existing accessibility features across all theme variants

**AC5: Create brand compliance validation ensuring color contrast and accessibility standards**
- Implement automated theme validation for WCAG compliance across all variants
- Create brand consistency checks for casino theme color authority
- Develop theme testing utilities for accessibility validation
- Ensure all casino themes meet existing accessibility and performance standards

**AC6: Preserve existing component behavior across all theme variants**
- Maintain all existing component APIs and functionality across theme switching
- Ensure existing educational content remains accessible in all theme variants
- Preserve current component performance characteristics across themes
- Validate that theme switching doesn't break existing user workflows

## Dev Notes

### System Architecture Context
[Source: 5.1 CSS Variable System, 5.2 Casino Colors, existing light-dark mode implementation]

**Current CSS Variable Architecture:**
```scss
// Existing _root.scss foundation to be extended
:root {
  // Base brand colors (to be theme-aware)
  --brand-primary: #1e40af;    // Educational authority
  --brand-secondary: #00d1b7;  // Interactive accent
  --brand-neutral: #b9bec4;    // Neutral foundation

  // Casino colors from Story 5.2
  --brand-casino: #dc2626;     // Casino red
  --brand-table: #16a34a;      // Table green
  --brand-premium: #f59e0b;    // Premium gold

  // OKLCH palette generation (preserve patterns)
  --color-primary-100: oklch(from var(--brand-primary) 95% calc(c * 0.3) h);
  // ... continues through 900

  // Automated light-dark mode (maintain functionality)
  --foreground-color: light-dark(var(--color-neutral-800), var(--color-neutral-100));
  --background-color: light-dark(var(--color-neutral-100), var(--color-neutral-900));
}
```

**Enhanced Theme-Aware Architecture:**
```scss
// Theme-aware CSS variable system
:root {
  // Theme selection mechanism
  --current-theme: 'educational'; // default theme

  // Theme-specific brand color mappings
  --theme-primary: var(--brand-primary);     // educational default
  --theme-secondary: var(--brand-secondary); // educational default
  --theme-accent: var(--brand-neutral);      // educational default
}

// Classic Casino Theme
[data-theme="classic-casino"] {
  --theme-primary: var(--brand-casino);      // Casino red authority
  --theme-secondary: var(--brand-table);     // Traditional green
  --theme-accent: var(--brand-premium);      // Gold highlights

  // Theme-specific semantic tokens
  --cta-color: var(--color-casino-600);
  --success-color: var(--color-table-500);
  --premium-color: var(--color-premium-500);
}

// Modern Casino Theme
[data-theme="modern-casino"] {
  --theme-primary: oklch(from var(--brand-casino) 60% 0.15 15);  // Modern red
  --theme-secondary: oklch(from var(--brand-table) 50% 0.12 160); // Modern green
  --theme-accent: oklch(from var(--brand-premium) 70% 0.18 85);   // Modern gold

  // Contemporary casino aesthetics
  --surface-glass: oklch(from var(--theme-primary) 95% 0.02 h / 0.8);
  --gradient-casino: linear-gradient(135deg, var(--theme-primary), var(--theme-accent));
}

// Premium Casino Theme
[data-theme="premium-casino"] {
  --theme-primary: var(--brand-premium);     // Gold as primary
  --theme-secondary: var(--brand-casino);    // Red as accent
  --theme-accent: oklch(from var(--brand-premium) 30% 0.1 h); // Dark gold

  // Luxury aesthetic enhancements
  --surface-premium: linear-gradient(145deg, var(--theme-primary), var(--theme-accent));
  --text-premium: oklch(from var(--theme-accent) 25% 0.05 h);
  --shadow-premium: 0 8px 32px oklch(from var(--theme-primary) 50% 0.1 h / 0.3);
}
```

### Theme Switching Implementation Strategy
[Source: existing state management patterns, nanostores integration]

**Theme State Management Integration:**
```typescript
// Theme state integration with existing sessionState.ts
import { atom, computed } from 'nanostores'

export type ThemeVariant = 'educational' | 'classic-casino' | 'modern-casino' | 'premium-casino'
export type ColorMode = 'light' | 'dark' | 'auto'

// Theme preference atom
export const selectedTheme = atom<ThemeVariant>('educational')
export const colorMode = atom<ColorMode>('auto')

// Computed theme state
export const currentTheme = computed([selectedTheme, colorMode], (theme, mode) => ({
  variant: theme,
  mode: mode === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : mode,
  isCasino: theme !== 'educational'
}))

// Theme switching utility
export function switchTheme(newTheme: ThemeVariant) {
  selectedTheme.set(newTheme)

  // Update DOM immediately
  document.documentElement.setAttribute('data-theme', newTheme)

  // Persist preference using existing localStorage pattern
  localStorage.setItem('roulettesim-theme', newTheme)

  // Track theme switch in analytics (existing pattern)
  analyticsService.trackThemeSwitch(newTheme)
}
```

**Component Theme Integration:**
```astro
---
// Theme-aware component enhancement pattern
interface ThemeAwareProps {
  // Existing props preserved
  className?: string

  // Theme enhancement (optional)
  themeAware?: boolean
  casinoVariant?: boolean
}

const { className = '', themeAware = false, casinoVariant = false } = Astro.props
---

<div class={`
  ${className}
  ${themeAware ? 'theme-aware' : ''}
  ${casinoVariant ? 'casino-enhanced' : ''}
`}>
  <slot />
</div>

<style>
.theme-aware {
  background: var(--theme-primary);
  color: var(--foreground-color);
  transition: background-color 0.3s ease, color 0.3s ease;
}

.casino-enhanced {
  /* Casino-specific enhancements that adapt to theme */
  background: var(--gradient-casino, var(--theme-primary));
  box-shadow: var(--shadow-premium, var(--shadow-md));
}
</style>
```

### Theme Validation and Brand Compliance
[Source: WCAG requirements, brand consistency standards]

**Automated Theme Validation System:**
```typescript
// Theme compliance validation utility
export class ThemeValidator {
  static async validateContrast(theme: ThemeVariant): Promise<ValidationResult> {
    const results = []

    // Get theme-specific colors
    const themeColors = await this.getThemeColors(theme)

    // Validate all color combinations
    for (const [bg, fg] of this.getColorCombinations(themeColors)) {
      const contrast = await this.calculateContrast(bg, fg)
      const passes = contrast >= 4.5 // WCAG AA standard

      results.push({
        background: bg,
        foreground: fg,
        contrast,
        passes,
        theme
      })
    }

    return {
      theme,
      overallPass: results.every(r => r.passes),
      results,
      score: this.calculateComplianceScore(results)
    }
  }

  static async validateBrandConsistency(theme: ThemeVariant): Promise<BrandValidation> {
    // Validate theme adheres to casino brand guidelines
    const brandRules = await this.getBrandRules(theme)
    const themeImplementation = await this.getThemeImplementation(theme)

    return this.validateAgainstBrandRules(themeImplementation, brandRules)
  }
}
```

**Build-Time Theme Validation:**
```typescript
// Astro integration for theme validation during build
export function themeValidationPlugin(): AstroIntegration {
  return {
    name: 'theme-validation',
    hooks: {
      'astro:build:start': async () => {
        const themes: ThemeVariant[] = ['educational', 'classic-casino', 'modern-casino', 'premium-casino']

        for (const theme of themes) {
          const contrastResult = await ThemeValidator.validateContrast(theme)
          const brandResult = await ThemeValidator.validateBrandConsistency(theme)

          if (!contrastResult.overallPass) {
            throw new Error(`Theme ${theme} fails WCAG contrast requirements`)
          }

          if (!brandResult.passes) {
            console.warn(`Theme ${theme} has brand consistency warnings:`, brandResult.warnings)
          }
        }

        console.log('All themes pass validation âœ“')
      }
    }
  }
}
```

### Theme-Aware Component Enhancement Patterns
[Source: existing component patterns, casino UX requirements]

**Button System Theme Integration:**
```scss
// Theme-aware button enhancements
.button {
  // Existing button foundation preserved
  background: var(--theme-primary);
  color: var(--foreground-color);

  // Theme-specific variants
  &.variant-casino {
    background: var(--gradient-casino, var(--theme-primary));
    box-shadow: var(--shadow-premium, var(--shadow-md));
  }

  &.variant-premium {
    background: var(--surface-premium, var(--theme-accent));
    color: var(--text-premium, var(--foreground-color));
  }

  // Theme transition animations
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);

  // Light-dark mode preservation within themes
  border: 1px solid light-dark(
    oklch(from var(--theme-primary) calc(l - 0.1) c h),
    oklch(from var(--theme-primary) calc(l + 0.1) c h)
  );
}
```

**GameFrame Theme Integration:**
```astro
---
// Enhanced GameFrame with theme awareness
interface GameFrameProps {
  gameId: string
  // Existing props preserved
  width?: string
  height?: string
  title?: string

  // Theme enhancements
  themeAware?: boolean
  premiumStyling?: boolean
}

const {
  gameId,
  width = "100%",
  height = "600px",
  title,
  themeAware = false,
  premiumStyling = false
} = Astro.props
---

<div class={`
  game-frame-container
  ${themeAware ? 'theme-integrated' : ''}
  ${premiumStyling ? 'premium-frame' : ''}
`}>
  <iframe
    src={`/api/game-embed/${gameId}?theme=${themeAware ? 'current' : 'default'}`}
    width={width}
    height={height}
    title={title}
    frameborder="0"
    allowfullscreen
  />
</div>

<style>
.theme-integrated {
  border-radius: var(--radius-lg);
  background: var(--surface-glass, var(--background-color));
  padding: var(--space-md);
}

.premium-frame {
  background: var(--surface-premium, var(--gradient-casino));
  box-shadow: var(--shadow-premium);
}
</style>
```

### Performance and Accessibility Considerations
[Source: 5.1 Performance Baseline, existing accessibility standards]

**Theme Switching Performance Optimization:**
```typescript
// Optimized theme switching with minimal layout thrash
export class ThemeManager {
  private static transitionDuration = 300 // ms

  static async switchTheme(newTheme: ThemeVariant) {
    // Prepare new theme variables
    const themeVariables = await this.getThemeVariables(newTheme)

    // Apply theme with smooth transition
    document.documentElement.style.setProperty('--theme-transition', `${this.transitionDuration}ms`)

    // Update CSS variables
    Object.entries(themeVariables).forEach(([property, value]) => {
      document.documentElement.style.setProperty(property, value)
    })

    // Update data attribute
    document.documentElement.setAttribute('data-theme', newTheme)

    // Clean up transition after completion
    setTimeout(() => {
      document.documentElement.style.removeProperty('--theme-transition')
    }, this.transitionDuration)

    // Update state and persistence
    selectedTheme.set(newTheme)
    localStorage.setItem('roulettesim-theme', newTheme)
  }
}
```

**Accessibility Preservation Across Themes:**
```scss
// Ensure accessibility features work across all themes
@media (prefers-reduced-motion: reduce) {
  [data-theme] * {
    transition-duration: 0.01ms !important;
    animation-duration: 0.01ms !important;
  }
}

@media (prefers-contrast: high) {
  [data-theme] {
    --theme-primary: light-dark(#000000, #ffffff);
    --theme-secondary: light-dark(#ffffff, #000000);
    --foreground-color: light-dark(#000000, #ffffff);
    --background-color: light-dark(#ffffff, #000000);
  }
}

// Maintain focus indicators across themes
[data-theme] :focus-visible {
  outline: 2px solid var(--theme-accent);
  outline-offset: 2px;
}
```

### File Structure and Implementation Locations
[Source: docs/architecture/source-tree.md, theming system patterns]

**Primary Implementation Files:**
- `/src/assets/scss/base/_themes.scss` - Theme variable definitions and switching logic
- `/src/assets/scss/components/_theme-aware.scss` - Theme-aware component styles
- `/src/stores/themeState.ts` - Theme state management and persistence
- `/src/utils/theme-validation.ts` - Theme compliance and brand validation utilities

**Component Integration Files:**
- `/src/components/theme/` - Theme-specific component variants
- `/src/components/ui/theme-aware/` - Enhanced theme-aware UI components
- `/src/layouts/ThemeAwareLayout.astro` - Theme-integrated layout wrapper

**Testing Implementation:**
- `/src/utils/__tests__/theme-validation.test.ts` - Theme validation testing
- `/tests/e2e/theming/` - End-to-end theme switching tests
- `/tests/accessibility/themes/` - Theme accessibility compliance testing

## Tasks / Subtasks

### Task 1: CSS Variable Architecture Extension for Theme Switching (AC: 1)
- [ ] 1.1. Extend existing OKLCH color system to support multiple casino theme variants
- [ ] 1.2. Implement theme switching preserving current CSS variable naming conventions
- [ ] 1.3. Create theme-aware component system maintaining existing APIs
- [ ] 1.4. Enable dynamic theme switching without requiring page reloads
- [ ] 1.5. Unit test: Theme switching functionality and CSS variable integrity validation

### Task 2: Casino Theme Variant Creation (AC: 2)
- [ ] 2.1. Develop "Classic Casino" theme with traditional casino red/green aesthetics
- [ ] 2.2. Create "Modern Casino" theme with contemporary casino design language
- [ ] 2.3. Implement "Premium Casino" theme for high-value customer segments
- [ ] 2.4. Maintain educational theme as default while adding casino options
- [ ] 2.5. Unit test: Theme variant implementation and visual consistency validation

### Task 3: Theme Persistence and State Management Integration (AC: 3)
- [ ] 3.1. Integrate theme selection with existing sessionState.ts and nanostores
- [ ] 3.2. Implement theme persistence using current localStorage patterns
- [ ] 3.3. Create theme preference API compatible with existing analytics service
- [ ] 3.4. Enable theme switching across all site sections with preference persistence
- [ ] 3.5. Integration test: Theme state management and persistence functionality validation

### Task 4: Light-Dark Mode Preservation Across Themes (AC: 4)
- [ ] 4.1. Preserve current light-dark() CSS function automation across casino themes
- [ ] 4.2. Ensure WCAG 4.5:1+ contrast ratios in both modes for all themes
- [ ] 4.3. Implement theme-aware light-dark mode switching respecting user preferences
- [ ] 4.4. Maintain existing accessibility features across all theme variants
- [ ] 4.5. Accessibility test: Light-dark mode functionality across all theme variants

### Task 5: Brand Compliance Validation System (AC: 5)
- [ ] 5.1. Implement automated theme validation for WCAG compliance across variants
- [ ] 5.2. Create brand consistency checks for casino theme color authority
- [ ] 5.3. Develop theme testing utilities for accessibility validation
- [ ] 5.4. Ensure all casino themes meet existing accessibility and performance standards
- [ ] 5.5. Integration test: Comprehensive theme validation and compliance verification

### Task 6: Component Behavior Preservation (AC: 6)
- [ ] 6.1. Maintain all existing component APIs and functionality across theme switching
- [ ] 6.2. Ensure existing educational content remains accessible in all theme variants
- [ ] 6.3. Preserve current component performance characteristics across themes
- [ ] 6.4. Validate that theme switching doesn't break existing user workflows
- [ ] 6.5. Regression test: Complete component ecosystem theme compatibility verification

## Project Structure Notes

**Alignment with Existing Architecture:**
- Theme system extends existing CSS variable architecture in `_root.scss` without conflicts
- State management integration follows established nanostores and localStorage patterns
- Component enhancement preserves existing domain organization and API consistency
- Performance considerations maintain current Core Web Vitals and accessibility standards

**Integration Compatibility:**
- Theme switching integrates seamlessly with existing Astro SSR and React islands architecture
- CSS variable extensions preserve existing design token system and OKLCH color patterns
- State management maintains compatibility with current analytics and user preference tracking
- Accessibility features enhanced while preserving existing WCAG compliance mechanisms

**No Architecture Conflicts Identified:**
- Theme system preserves existing component APIs while adding optional enhancement capabilities
- CSS variable extensions maintain backward compatibility with existing styling patterns
- Performance optimizations align with current build pipeline and deployment workflow
- Accessibility preservation ensures existing standards maintained across all theme variants

## Testing Requirements

**Unit Testing (Vitest):**
- Theme switching functionality and CSS variable integrity validation
- Casino theme variant implementation and visual consistency verification
- Theme state management and persistence functionality testing
- Brand compliance validation utility accuracy and completeness testing

**Integration Testing:**
- Theme system integration with existing component ecosystem
- Light-dark mode functionality preservation across all theme variants
- Performance impact measurement for theme switching operations
- Cross-browser theme compatibility validation

**End-to-End Testing (Playwright):**
- Complete theme switching workflow testing across all casino variants
- Educational content accessibility validation in all theme variants
- Performance benchmark maintenance with theme enhancement features
- User preference persistence and analytics integration verification

**Accessibility Testing (Axe):**
- WCAG compliance verification across all theme variants in light and dark modes
- Screen reader compatibility with theme-aware component enhancements
- Keyboard navigation testing for theme switching functionality
- High contrast mode compatibility validation across all casino themes

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-19 | v1.0 | Initial story creation for advanced theming & brand consistency | Development Agent (James) |

## Dev Agent Record

### Agent Model Used
*To be populated during implementation*

### Debug Log References
*To be populated during implementation*

### Completion Notes List
*To be populated during implementation*

### File List
*To be populated during implementation*

## QA Results

*Results from QA Agent review to be completed after implementation*